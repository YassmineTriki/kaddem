pipeline {
    agent any
    tools {
        jdk 'JDK-17'      // Nom de votre JDK configuré dans Jenkins
        maven 'Maven-3.9'
    }
    environment {
         // Active le profil 'test' uniquement pour les étapes de test
         TEST_PROFILE = '-Dspring.profiles.active=test'
         DOCKER_IMAGE = "kaddem-app"
         DOCKER_TAG = "${env.BUILD_ID}"       // Utilise le numéro de build Jenkins comme tag
    }
    stages {
        // Étape 1 : Récupération du code
        stage('Checkout Git') {
            steps {
                git branch: 'master', url: 'https://github.com/YassmineTriki/kaddem.git'
            }
        }
        /* Étape 2 - Build */
        stage('Build') {
              steps {
                  sh 'ls -l mvnw'
                  sh './mvnw clean compile -DskipTests'
              }
        }
        /* Étape 3 - Tests Unitaires (nouveau) */
         stage('Unit Tests') {
                    steps {
                         sh """
                         ./mvnw test $TEST_PROFILE \
                         -Dspring.datasource.url=jdbc:h2:mem:testdb \
                         -Dspring.jpa.hibernate.ddl-auto=create-drop
                         """
                    }
                    post {
                        always {
                            junit '**/target/surefire-reports/*.xml'  // Publie les rapports JUnit
                              archiveArtifacts artifacts: '**/target/surefire-reports/*.txt', allowEmptyArchive: true
                        }
                    }
         }
          /* Étape 4 - Packaging final */
          stage('Package') {
                        steps {
                            sh './mvnw clean package -DskipTests'
                            // Vérification que le WAR est généré
                            sh 'ls -l target/*.war'
                        }
                    }
          // Étape 4: Analyse SonarQube
          stage('SonarQube Analysis') {
                   steps {
                         withSonarQubeEnv('SonarQube-Server') {
                             sh 'mvn sonar:sonar -Dsonar.projectKey=kaddem'
                         }

                     }
          }
          // Étape 5: Nexus

          stage('Nexus') {
              steps {
                    nexusArtifactUploader(
                                artifacts: [[
                                    artifactId: 'kaddem', // Doit matcher <artifactId>
                                    file: 'target/kaddem-0.0.1-SNAPSHOT.war', // Nom exact
                                    type: 'war' // Spring Boot génère un .jar par défaut
                                ]],
                                credentialsId: 'nexus',
                                groupId: 'tn.esprit.spring', // Doit matcher <groupId>
                                nexusUrl: 'localhost:8081',
                                nexusVersion: 'nexus3',
                                protocol: 'http',
                                repository: 'maven-snapshots',
                                version: '0.0.1-SNAPSHOT' // Doit matcher <version>
                    )

              }
          }

       stage('Build and Deploy') {
           steps {
               script {
                   def IMAGE_NAME = "yasmine251/kaddem-app"
                   def IMAGE_TAG = env.BUILD_ID

                   // Vérification préalable
                   sh """
                       echo "Contenu du répertoire :"
                       ls -la
                       echo "Recherche du dockerFile..."
                       find . -name dockerFile -o -name docker-compose.yml
                   """

                   // 2. Publication optionnelle
                   if (env.DOCKER_REGISTRY) {
                       docker.withRegistry("https://${env.DOCKER_REGISTRY}", 'DOCKER_HUB_CREDS') {
                           sh """
                               docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${env.DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                               docker push ${env.DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                           """
                       }
                   }

                   // 3. Déploiement sécurisé
                   sh """
                       # Vérification du docker-compose.yml
                       if [ ! -f docker-compose.yml ]; then
                           echo "ERREUR: docker-compose.yml introuvable!"
                           exit 1
                       fi

                       # Modification atomique
                       cp docker-compose.yml docker-compose.tmp
                       sed 's|image:.*|image: ${IMAGE_NAME}:${IMAGE_TAG}|g' docker-compose.tmp > docker-compose.yml
                       rm docker-compose.tmp

                       # Redémarrage
                       docker-compose down || true
                       docker system prune -f
                       docker-compose up -d --build
                       docker-compose ps
                   """
                   echo "Déploiement réussi! Version ${IMAGE_TAG}"
               }
           }
       }

    }


}