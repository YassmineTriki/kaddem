pipeline {
    agent any
    tools {
        jdk 'JDK-17'
        maven 'Maven-3.9'
    }
    environment {
        TEST_PROFILE = '-Dspring.profiles.active=test'
        DOCKER_IMAGE = "kaddem-app"
        DOCKER_TAG = "${env.BUILD_ID}"
    }
    stages {
        // Étape 1: Clonage du projet
        stage('Checkout Git') {
            steps {
                git branch: 'master',
                url: 'https://github.com/YassmineTriki/kaddem.git',
                credentialsId: 'github-credentials'
            }
        }

        // Étape 2: Nettoyage et compilation
        stage('Build') {
            steps {
                sh '''
                    echo "Nettoyage du projet..."
                    rm -rf target/
                    ./mvnw clean compile -DskipTests
                '''
            }
        }

        // Étape 3: Tests unitaires avec H2
        stage('Unit Tests') {
            steps {
                sh """
                    ./mvnw test $TEST_PROFILE \\
                    -Dspring.datasource.url=jdbc:h2:mem:testdb \\
                    -Dspring.datasource.username=sa \\
                    -Dspring.datasource.password= \\
                    -Dspring.jpa.hibernate.ddl-auto=create-drop \\
                    -Dspring.jpa.show-sql=true
                """
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                    archiveArtifacts artifacts: '**/target/surefire-reports/*.txt', allowEmptyArchive: true
                }
            }
        }

        // Étape 4: Packaging final
        stage('Package') {
            steps {
                sh './mvnw clean package -DskipTests'
                sh 'ls -l target/*.war'
            }
        }

        // Étape 5: Analyse SonarQube
        stage('SonarQube Analysis') {
                           steps {
                                 withSonarQubeEnv('SonarQube-Server') {
                                     sh 'mvn sonar:sonar -Dsonar.projectKey=kaddem'
                                 }

                             }
        }

        // Étape 6: Déploiement sur Nexus
         stage('Nexus') {
                      steps {
                            nexusArtifactUploader(
                                        artifacts: [[
                                            artifactId: 'kaddem', // Doit matcher <artifactId>
                                            file: 'target/kaddem-0.0.1-SNAPSHOT.war', // Nom exact
                                            type: 'war' // Spring Boot génère un .jar par défaut
                                        ]],
                                        credentialsId: 'nexus',
                                        groupId: 'tn.esprit.spring', // Doit matcher <groupId>
                                        nexusUrl: 'localhost:8081',
                                        nexusVersion: 'nexus3',
                                        protocol: 'http',
                                        repository: 'maven-snapshots',
                                        version: '0.0.1-SNAPSHOT' // Doit matcher <version>
                            )

                      }
                  }

        // Étape 7: Construction et déploiement Docker
        stage('Build and Deploy Docker') {
            steps {
                script {
                    // Construction des images
                    sh 'docker-compose build --no-cache'

                    // Démarrage des containers
                    sh 'docker-compose up -d'

                    // Vérification
                    sh 'docker-compose ps'
                    sh 'echo "Déploiement réussi! Version ${env.BUILD_ID}"'

                    // Nettoyage
                    sh 'docker system prune -f'
                }
            }
        }
    }
    post {
        always {
            cleanWs()
        }
        success {
            slackSend(color: 'good', message: "Build ${env.BUILD_NUMBER} réussi!")
        }
        failure {
            slackSend(color: 'danger', message: "Build ${env.BUILD_NUMBER} a échoué!")
        }
    }
}